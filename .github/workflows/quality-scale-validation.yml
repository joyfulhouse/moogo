name: Home Assistant Integration Quality Scale Validation

on:
  push:
    branches:
      - 'claude/**'
      - 'main'
      - 'develop'
  pull_request:
    branches:
      - 'main'

env:
  PYTHON_VERSION: "3.11"

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Check code formatting with Black
        run: |
          black --check . || echo "::warning::Code formatting issues found. Run 'black .' to fix."

      - name: Run Ruff linter
        run: |
          ruff check . || echo "::warning::Linting issues found."

      - name: Type checking with mypy (Platinum tier)
        continue-on-error: true
        run: |
          mypy custom_components/moogo || echo "::warning::Type checking issues found (Platinum tier requirement)"

  test-coverage:
    name: Test Coverage
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests with coverage
        run: |
          pytest tests/ --cov=custom_components/moogo --cov-report=xml --cov-report=term --cov-report=html -v

      - name: Check coverage threshold (Silver: 95%)
        run: |
          COVERAGE=$(python -c "import xml.etree.ElementTree as ET; print(float(ET.parse('coverage.xml').getroot().attrib['line-rate']) * 100)")
          echo "Coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE >= 95" | bc -l) )); then
            echo "âœ“ Meets Silver tier coverage requirement (â‰¥95%)"
          elif (( $(echo "$COVERAGE >= 90" | bc -l) )); then
            echo "::warning::Coverage ${COVERAGE}% is good but below Silver tier requirement (95%)"
          else
            echo "::warning::Coverage ${COVERAGE}% needs improvement"
          fi

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: matrix.python-version == '3.11'
        with:
          files: ./coverage.xml
          flags: unittests
          name: moogo-integration

  bronze-tier-validation:
    name: Bronze Tier Requirements
    runs-on: ubuntu-latest
    needs: [code-quality]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate manifest.json structure
        run: |
          python -c "
          import json
          manifest = json.load(open('manifest.json'))
          required_keys = ['domain', 'name', 'codeowners', 'config_flow', 'documentation', 'version']
          for key in required_keys:
              assert key in manifest, f'Missing required key: {key}'
          print('âœ“ manifest.json structure valid')
          "

      - name: Check Bronze tier requirements
        run: |
          echo "Checking Bronze Tier Requirements..."

          # config-flow
          [ -f "config_flow.py" ] && echo "âœ“ config-flow: Enabled" || exit 1

          # runtime-data
          grep -q "runtime_data" __init__.py && echo "âœ“ runtime-data: Implemented" || exit 1

          # has-entity-name
          grep -rq "_attr_has_entity_name = True" *.py && echo "âœ“ has-entity-name: Implemented" || exit 1

          # entity-unique-id
          grep -rq "_attr_unique_id" *.py && echo "âœ“ entity-unique-id: Implemented" || exit 1

          # test-before-setup
          grep -q "test_connection" __init__.py && echo "âœ“ test-before-setup: Implemented" || exit 1

          # config-flow-test-coverage
          [ -f "tests/test_config_flow.py" ] && echo "âœ“ config-flow-test-coverage: Present" || exit 1

          # config-entry-unloading
          grep -q "async_unload_entry" __init__.py && echo "âœ“ config-entry-unloading: Supported" || exit 1

          echo ""
          echo "ðŸ¥‰ Bronze Tier: PASSED"

  silver-tier-validation:
    name: Silver Tier Requirements
    runs-on: ubuntu-latest
    needs: [bronze-tier-validation, test-coverage]
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Silver tier requirements
        run: |
          echo "Checking Silver Tier Requirements..."

          # reauthentication-flow (to be implemented)
          if grep -q "async_step_reauth" config_flow.py 2>/dev/null; then
            echo "âœ“ reauthentication-flow: Implemented"
          else
            echo "â—‹ reauthentication-flow: Not yet implemented"
          fi

          # entity-unavailable
          if grep -rq "unavailable" sensor.py switch.py 2>/dev/null; then
            echo "âœ“ entity-unavailable: Implemented"
          else
            echo "â—‹ entity-unavailable: Needs implementation"
          fi

          # parallel-updates
          if grep -rq "PARALLEL_UPDATES" sensor.py switch.py 2>/dev/null; then
            echo "âœ“ parallel-updates: Specified"
          else
            echo "â—‹ parallel-updates: Not yet specified"
          fi

          echo ""
          echo "ðŸ¥ˆ Silver Tier: In Progress"

  gold-tier-validation:
    name: Gold Tier Requirements
    runs-on: ubuntu-latest
    needs: [silver-tier-validation]
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Gold tier requirements
        run: |
          echo "Checking Gold Tier Requirements..."

          # diagnostics
          if [ -f "diagnostics.py" ]; then
            echo "âœ“ diagnostics: Implemented"
          else
            echo "â—‹ diagnostics: Not yet implemented"
          fi

          # entity-category
          if grep -rq "entity_category" *.py 2>/dev/null; then
            echo "âœ“ entity-category: Assigned"
          else
            echo "â—‹ entity-category: Not yet assigned"
          fi

          # entity-translations
          if [ -d "translations" ]; then
            echo "âœ“ entity-translations: Present"
          else
            echo "â—‹ entity-translations: Not yet present"
          fi

          # reconfiguration-flow
          if grep -q "async_step_reconfigure" config_flow.py 2>/dev/null; then
            echo "âœ“ reconfiguration-flow: Implemented"
          else
            echo "â—‹ reconfiguration-flow: Not yet implemented"
          fi

          echo ""
          echo "ðŸ¥‡ Gold Tier: In Progress"

  platinum-tier-validation:
    name: Platinum Tier Requirements
    runs-on: ubuntu-latest
    needs: [gold-tier-validation]
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Check Platinum tier requirements
        run: |
          echo "Checking Platinum Tier Requirements..."

          # strict-typing
          if mypy custom_components/moogo --strict 2>/dev/null; then
            echo "âœ“ strict-typing: Passes strict mypy"
          else
            echo "â—‹ strict-typing: Not yet passing strict checks"
          fi

          # async-dependency
          if grep -q "aiohttp" manifest.json; then
            echo "âœ“ async-dependency: Using async library"
          else
            echo "â—‹ async-dependency: Needs async library"
          fi

          echo ""
          echo "ðŸ† Platinum Tier: In Progress"

  summary:
    name: Quality Scale Summary
    runs-on: ubuntu-latest
    needs: [bronze-tier-validation]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "# Home Assistant Integration Quality Scale Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Current Status" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ¥‰ **Bronze Tier**: PASSED âœ“" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ¥ˆ **Silver Tier**: In Progress..." >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ¥‡ **Gold Tier**: Planned" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ† **Platinum Tier**: Planned" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "View the [Quality Scale Rules](https://developers.home-assistant.io/docs/core/integration-quality-scale/rules/) for more information." >> $GITHUB_STEP_SUMMARY
